<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Actor と async データ :: Motoko documentation</title>
    <meta name="generator" content="Antora 2.3.4">
<link rel="stylesheet" href="../../_/css/site.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /><meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:title" content="The Internet Computer | Documentation" />
<meta property="og:description" content="Documentation for the internet computer." />
<meta property="og:image" content="../../_/img/share.jpg" />
<meta property="og:image:url" content="../../_/img/share.jpg" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@DFINITYDev" />
<meta name="twitter:image" content="../../_/img/logo-RGB.png" />
<meta name="twitter:image:alt" content="DFINITY Logo" />    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="logo-container" href="https://dfinity.org/">
        <img class="header-logo" src="../../_/img/logo.svg">
        <h1 class="header-title">Motoko documentation</h1>
      </a>
    </div>
    <div class="nav-items-wrapper">
      <div class="search-container">
  <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd"
      d="M11.8654 12.5892C10.8213 13.4695 9.47259 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2C11.3137 2 14 4.68629 14 8C14 9.47209 13.4699 10.8204 12.5901 11.8643L17.3625 16.6367L16.6377 17.3615L11.8654 12.5892ZM12.9333 8C12.9333 10.7246 10.7246 12.9333 8 12.9333C5.2754 12.9333 3.06667 10.7246 3.06667 8C3.06667 5.2754 5.2754 3.06667 8 3.06667C10.7246 3.06667 12.9333 5.2754 12.9333 8Z"
      fill="black" />
  </svg>


  <input class="search-input" placeholder="Search" type="search" />
</div>      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div id="topbar-nav" class="navbar-menu">
        <div class="navbar-end">
          <a class="navbar-item" target="blank" href="https://forum.dfinity.org/">Forum</a>
          <a class="navbar-item" target="blank" href="mailto:support@dfinity.org?subject=Feedback - SDK Developer Center">Email us</a>
          <a class="navbar-item" target="blank" href="https://www.twitter.com/dfinitydev">
            <img src="../../_/img/social/twitter-icon.svg">
          </a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">docs</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">docs</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="file:///build/doc/modules/language-guide/pages/actors-async.adoc"><svg class="edit-icon" xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/><path d="M0 0h24v24H0z" fill="none"/></svg></a></div>
</div>
<div class="main-content">
<article class="doc">
<h1 class="page">Actor と async データ</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Internet Computer のプログラミングモデルは、メモリが分離された Canister が、Candid の値をエンコードしたバイナリデータを非同期にメッセージングして通信するというものです。
Canister はそのメッセージを一度に処理し、競合状態を防ぎます。
Canister はコールバックを使用して、Canister 間で発行したメッセージの結果に対して何をする必要があるかを登録します。</p>
</div>
<div class="paragraph">
<p>Motoko は、Internet Computer の複雑さを、よく知られている高レベルの抽象化である <em>Actor</em> モデルで抽象化します。
各 Canister は型付けされた Actor として表現されます。Actor の型は、その Actor が扱えるメッセージのリストです。各メッセージは型付きの非同期関数として抽象化されます。
Actor 型から Candid 型への変換は、基礎となる Internet Computer の生のバイナリデータの構造を強制します。
Actor はオブジェクトに似ていますが、そのステートが完全に分離されていること、外部環境とのやりとりが完全に非同期のメッセージングによって行われること、同時進行中の Actor によって並列に発行されたメッセージであっても一度に処理されることが異なります。</p>
</div>
<div class="paragraph">
<p>Motoko では、Actor へのメッセージ送信は関数呼び出しですが、呼び出しが戻るまで発信側をブロッキングするのではなく、メッセージが受信側のキューに入り、リクエストが保留中であることを表す <em>future</em> が発信側にすぐに返されます。
future は、発信側がリクエストを実行したときの最終的な結果に対するプレースホルダーであり、後でクエリすることができます。
リクエストを発行してから結果を待つまでの間、発信側は同じ Actor や他の Actor にさらにリクエストを発行するなど、他の作業を自由に行うことができます。
受信側がリクエストを処理すると、future が完了し、その結果が発信側に返され利用できるようになります。
発信側が future を待っている場合は、結果が返り次第処理を再開するか、そうでない場合は結果を後で使用できるように future に保存します。</p>
</div>
<div class="paragraph">
<p>Motoko では、Actor は専用の構文と型を持っています。メッセージングは、future を返す <em>shared</em> 関数と呼ばれる関数で処理されます（リモートの Actor が利用できるため、shared と呼ばれます）。
ここで、future の <code>f</code> が、ある型 <code>T</code> に対する特別な型である <code>async T</code> の値であるとします。
<code>f</code> が完了するのを待つことは、<code>await f</code> を使って <code>T</code> 型の値を得ることで表現されます。
メッセージングにおいて共有ステートを持たないようにするには、例えばオブジェクトや可変配列を送信するなどの方法があります。
shared 関数で送信できるデータは、不変の <em>shared</em> 型に制限されています。</p>
</div>
<div class="paragraph">
<p>はじめに、最も単純でステートフル（状態を保持する）な Service を考えてみましょう。以前のローカル <code>counter</code> オブジェクトの分散バージョンである <code>Counter</code> Actor です。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_例カウンタの_service"><a class="anchor" href="#_例カウンタの_service"></a>例：カウンタの Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>以下のような Actor の宣言を考えます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">actor Counter {

  var count = 0;

  public shared func inc() : async () { count += 1 };

  public shared func read() : async Nat { count };

  public shared func bump() : async Nat {
    count += 1;
    count;
  };
};</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Counter</code> Actor は、1つのフィールドと3つのパブリックな <em>shared</em> 関数を宣言しています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>フィールド <code>count</code> は可変で、0 に初期化され、暗黙的に <code>private</code> となります。</p>
</li>
<li>
<p>関数 <code>inc()</code> は、非同期的にカウンタをインクリメントし、同期のために <code>async ()</code> 型の future を返します。</p>
</li>
<li>
<p>関数 <code>read()</code> は、非同期にカウンタの値を読み込み、その値を含む <code>async Nat</code> 型の future を返します。</p>
</li>
<li>
<p>関数 <code>bump()</code> は、非同期的にカウンタをインクリメントし、値を読み込みます。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>shared 関数は、ローカル関数とは異なり、リモートの呼び出し元からアクセス可能です。さらに、引数と戻り値は <em>shared</em> 型でなければならないという追加の制限があります。shared 型はイミュータブルなデータ、Actor の参照、shared 関数の参照などを含む型のサブセットですが、ローカル関数への参照とミュータブルなデータは含まれません。Actor とのやりとりはすべて非同期で行われるので、Actor の関数は必ず future を返さなければなりません。つまり、ある型 <code>T</code> に対して <code>async T</code> という形の型を返さなければなりません。</p>
</div>
<div class="paragraph">
<p><code>Counter</code> Actor のステート（<code>count</code>）を読み取ったり変更したりするには、shared 関数を使用するしかありません。</p>
</div>
<div class="paragraph">
<p><code>async T</code> 型の値は future です。future の生成元は、値またはエラーの結果を返した時点で future を完了させます。</p>
</div>
<div class="paragraph">
<p>オブジェクトやモジュールとは異なり、Actor は関数のみを公開することができ、それらは <code>shared</code> 関数である必要があります。このため Motoko では、パブリックな Actor 関数の <code>shared</code> 修飾子を省略することができ、より簡潔に同じ Actor を宣言することが可能になっています。</p>
</div>
<div id="counter" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">actor Counter {

  var count = 0;

  public func inc() : async () { count += 1 };

  public func read() : async Nat { count };

  public func bump() : async Nat {
    count += 1;
    count;
  };
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>現在、shared 関数を宣言できるのは、Actor や Actor クラスのボディの中だけです。このような制限はあるものの、shared 関数は Motoko の第一級関数であり、引数や返り値として渡したり、データ構造に格納したりすることができます。</p>
</div>
<div class="paragraph">
<p>shared 関数の型は、shared 関数型を使って指定します。たとえば、<code>inc</code> の型は <code>shared () &#8594; async Nat</code> であり、他の Service への独立したコールバックとして渡すことができます (例として <a href="sharing.html">publish-subscribe</a> を参照してください)。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_actor_型"><a class="anchor" href="#_actor_型"></a>Actor 型</h2>
<div class="sectionbody">
<div class="paragraph">
<p>オブジェクトにオブジェクト型があるように、Actor には <em>Actor 型</em> があります。<code>Counter</code> Actor は、以下の型を持っています。</p>
</div>
<div class="listingblock no-repl">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">actor {
  inc  : shared () -&gt; async ();
  read : shared () -&gt; async Nat;
  bump : shared () -&gt; async Nat;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>繰り返しになりますが、<code>shared</code> 修飾子は Actor のすべてのメンバー関数に必要なので、Motoko では、表示時と Actor 型を書く際に記載を省略することができます。</p>
</div>
<div class="paragraph">
<p>よって、先述の型はより簡潔に表現すると次のようになります。</p>
</div>
<div class="listingblock no-repl">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">actor {
  inc  : () -&gt; async ();
  read : () -&gt; async Nat;
  bump : () -&gt; async Nat;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>オブジェクト型と同様に、Actor 型も派生型をサポートしています。ある Actor 型は、より一般的な型を使っていて、関数の数がより少ない Actor の派生型となります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_await_を使って非同期の_future_を使用する"><a class="anchor" href="#_await_を使って非同期の_future_を使用する"></a><code>await</code> を使って非同期の future を使用する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>shared 関数の呼び出し側は、一般的には、ある T についての <code>async T</code> 型の値である future を受け取ります。</p>
</div>
<div class="paragraph">
<p>呼び出し側であるコンシューマ（受け取り側）がこの future に対してできることは、プロデューサ（future の生成側）の処理が完了するのを待つか、future を捨ててしまうか、後で使うために保存するかです。</p>
</div>
<div class="paragraph">
<p><code>async</code> 値の結果にアクセスするには、future の受け取り側で <code><strong>await</strong></code> 式を使用します。</p>
</div>
<div class="paragraph">
<p>例えば、上述の <code>Counter.read()</code> の結果を利用するには、まず future を変数 <code>a</code> にバインドし、次に <code>await</code> で future 処理後の返り値となる <code>Nat</code> の <code>n</code> を取得します。</p>
</div>
<div class="listingblock include_counter">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">let a : async Nat = Counter.read();
let n : Nat = await a;</code></pre>
</div>
</div>
<div class="paragraph">
<p>1行目はすぐに <em>カウンタ値の future</em> を受け取りますが、処理の完了を待っていないため、自然数として使用することは（まだ）できません。</p>
</div>
<div class="paragraph">
<p>2行目は、この future を <code>await</code> し、その結果を自然数で取り出します。
この行は、future の処理が完了するまで実行をブロッキングします。</p>
</div>
<div class="paragraph">
<p>一般的には、2つのステップを1つにまとめ、非同期呼び出しを直接 <code>await</code> します。</p>
</div>
<div class="listingblock include_counter">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">let n : Nat = await Counter.read();</code></pre>
</div>
</div>
<div class="paragraph">
<p>呼び出し先が結果を返すまでブロッキングするローカル関数の呼び出しとは異なり、shared 関数の呼び出しは future である <code>f</code> をブロッキングせずにすぐに返します。
呼び出し時にブロッキングする代わりに、後で <code>await f</code> を呼び出すと、<code>f</code> が完了するまで現在の計算が中断されます。
呼び出し先によって future が完了すると、<code>await f</code> の実行はその結果とともに再開されます。
もし結果が値であれば、<code>await f</code> はその値を返します。
そうでなければ、結果は何らかのエラーであり、<code>await f</code> はそのエラーを <code>await f</code> の呼び出し側に伝播させます。</p>
</div>
<div class="paragraph">
<p>future を 2 回 await しても同じ結果になり、future に何らかのエラーが格納されている場合にはそのエラーが再びスローされます。
サスペンドは、future がすでに完了していても発生します。これによって、<em>それぞれの</em> <code>await</code> の前に行われたステートの変更やメッセージ送信が確実にコミットされます。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>await</code> を含まない関数はアトミックに実行されることが保証されています。具体的には、関数の実行中に環境が Actor のステートを変更することはできません。しかしながら、関数が <code>await</code> を実行すると、アトミック性は保証されなくなります。
<code>await</code> によって実行が一時停止され再開するまでの間、その Actor のステートは他の Actor からのメッセージの同時処理により変化する可能性があります。非同期の状態変化を防ぐのはプログラマの責任です。ただし、プログラマは <code>await</code> がコミットされる前に行われた状態変化に関しては、他の Actor からの干渉がないことを信じることができます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>例えば上記の <code>bump()</code> の実装では、<code>count</code> の値を 1 つのアトミックなステップでインクリメントし、読み取ることが保証されています。
別の実装としては以下が考えられます。</p>
</div>
<div class="listingblock no-repl">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">  public shared func bump() : async Nat {
    await inc();
    await read();
  };</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは上記の <code>bump()</code> の実装とは異なるセマンティクスとなり、Actor の別のクライアントが操作に干渉することを可能にします。それぞれの <code>await</code> は実行を一時停止するので、別の Actor がこの Actor のステートを関数の実行中に変更することが可能になります。
設計上、明示的な <code>await</code> は干渉の可能性があるポイントを、コードを読む人に対して明確にします。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_トラップとコミットポイント"><a class="anchor" href="#_トラップとコミットポイント"></a>トラップとコミットポイント</h2>
<div class="sectionbody">
<div class="paragraph">
<p>トラップとは、ゼロ除算、範囲外への配列インデックス、数値のオーバーフロー、Cycle の枯渇、アサーションの失敗などが原因で発生する、回復不能なランタイムエラーのことです。</p>
</div>
<div class="paragraph">
<p><code>await</code> 式を実行せずに実行される shared 関数の呼び出しは、サスペンドせずにアトミックに実行されます。<code>await</code> 式を含まない shared 関数は、構文的にアトミックです。</p>
</div>
<div class="paragraph">
<p>アトミックな shared 関数は、その実行時のトラップによって Actor のステートやその環境に目に見える影響を与えません。
すなわち、トラップされた場合にはステートの変化はすべて元に戻され、送信したメッセージはすべて破棄されます。
実際には、すべての状態変化とメッセージ送信は、実行中は暫定的なものであり、エラー無しに <em>コミットポイント</em> に到達して初めてコミットされます。</p>
</div>
<div class="paragraph">
<p>暫定的な状態変化やメッセージ送信が取り消されずにコミットされるポイントは以下の通りです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>結果を生成することによる shared 関数の暗黙的な終了</p>
</li>
<li>
<p><code>return</code> や <code>throw</code> 式による明示的な終了</p>
</li>
<li>
<p>明示的な <code>await</code> 式</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>トラップが起こると、最後のコミットポイント以降に行われた変更のみが取り消されます。特に、複数の <code>await</code> を行う非アトミック関数では、トラップが起こると最後の <code>await</code> 以降に行われた変更のみが取り消され、その前のすべての副作用はコミットされてしまい、元に戻すことはできません。</p>
</div>
<div class="paragraph">
<p>例えば、次のような（作為的に）ステートフルな <code>Atomicity</code> Actor を考えてみましょう。</p>
</div>
<div class="listingblock no-repl">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">actor Atomicity {

  var s = 0;
  var pinged = false;

  public func ping() : async () {
    pinged := true;
  };

  // an atomic method
  public func atomic() : async () {
    s := 1;
    ignore ping();
    ignore 0/0; // trap!
  };

  // a non-atomic method
  public func nonAtomic() : async () {
    s := 1;
    let f = ping(); // this will not be rolled back!
    s := 2;
    await f;
    s := 3; // this will not be rolled back!
    await f;
    ignore 0/0; // trap!
  };

};</code></pre>
</div>
</div>
<div class="paragraph">
<p>shared 関数である <code>atomic()</code> を呼び出すと、最後のステートメントがトラップを引き起こしてエラーとなります。しかし、このトラップによって、可変型変数 <code>s</code> の値は <code>1</code> ではなく <code>0</code> になり、変数 <code>pinged</code> の値は <code>true</code> ではなく <code>false</code> になります。これは、<code>atomic</code> メソッド が <code>await</code> を実行する前、あるいは結果の値を得て終了する前にトラップが発生しているためです。<code>atomic</code> が <code>ping()</code> を呼び出しても、<code>ping()</code> は次のコミットポイントまでの暫定的なもの (キューされたもの) なので、反映されることはありません。</p>
</div>
<div class="paragraph">
<p>shared 関数である <code>nonAtomic()</code> を呼び出すと、最後のステートメントがトラップを引き起こしてエラーとなります。しかし、このトラップによって、変数 <code>s</code> の値は <code>0</code> ではなく <code>3</code> になり、変数 <code>pinged</code> の値は <code>false</code> ではなく <code>true</code> になります。これは、各 <code>await</code> がメッセージ送信などの先行する副作用をコミットするためです。<code>f</code> に対する 2 回目の await で <code>f</code> が完了しても、この await はステートを強制的にコミットし、実行を一時停止して、この Actor への他のメッセージのインターリーブ処理が可能になります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_クエリ関数"><a class="anchor" href="#_クエリ関数"></a>クエリ関数</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Internet Computer 用語では、3つの <code>Counter</code> 関数はすべて <em>アップデート</em> メッセージであり、関数が呼ばれると Canister のステートを変更することができます。
ステートを変更するには、Internet Computer が変更をコミットして結果を返す前に、分散したレプリカ間の合意が必要です。
コンセンサスを得るのは、比較的高いレイテンシを伴う高価なプロセスです。</p>
</div>
<div class="paragraph">
<p>コンセンサスの保証を必要としないアプリケーションの部分については、Internet Computer はより効率的であるクエリ操作をサポートしています。
これは、単一のレプリカから Canister のステートを読み取り、実行中にスナップショットを変更して結果を返すことができますが、ステートを恒久的に変更したり、さらなる Internet Computer のメッセージを送信することはできません。</p>
</div>
<div class="paragraph">
<p>Motoko は、<code>query</code> 関数を使用した Internet Computer のクエリの実装をサポートしています。<code>query</code> キーワードは shared Actor 関数の宣言を変更し、コミットせずに高速で実行されるクエリのセマンティクスになるようにします。</p>
</div>
<div class="paragraph">
<p>例えば、信頼性の高い <code>read</code> 関数をルーズにした <code>peek</code> 関数で <code>Counter</code> Actor を拡張してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">actor Counter {

  var count = 0;

  // ...

  public shared query func peek() : async Nat {
    count
  };

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>peek()</code> 関数は、<code>Counter</code> フロントエンドで現在のカウンタの値を素早く（ただし信頼性低く）表示するのに使用される可能性があります。</p>
</div>
<div class="paragraph">
<p>クエリメソッドが Actor の関数を呼び出すことは、Internet Computer が課す動的な制限に違反するため、コンパイルエラーとなります。通常の関数への呼び出しは許可されています。</p>
</div>
<div class="paragraph">
<p>クエリ関数は、非クエリ関数から呼び出すことができます。
これらのネストされた呼び出しにはコンセンサスが必要なため、ネストされたクエリコールの効率化は期待できないでしょう。</p>
</div>
<div class="paragraph">
<p><code>query</code> 修飾子はクエリ関数の型に反映されます。</p>
</div>
<div class="listingblock no-repl">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">  peek : shared query () -&gt; async Nat</code></pre>
</div>
</div>
<div class="paragraph">
<p>これまでと同様、<code>query</code> の宣言や Actor 型では、<code>shared</code> キーワードを省略することができます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_メッセージングの制限"><a class="anchor" href="#_メッセージングの制限"></a>メッセージングの制限</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Internet Computer は、Canister がいつどのように通信可能かについて制限を設けています。これらの制限は Internet Computer 上では動的に実施されますが、Motoko では静的に防止されるため、動的実行エラーの類を排除します。2つの例は以下の通りです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Canister の設置時はコードを実行できますが、メッセージを送信できません。</p>
</li>
<li>
<p>Canister のクエリメソッドはメッセージを送信できません。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらの制限は、Motoko ではどの式を使用できるかというコンテキストの制限として表れています。</p>
</div>
<div class="paragraph">
<p>Motoko では、（shared またはローカルの関数のボディ内や独立した式として登場する）<code>async</code> 式のボディ内に式が登場するとき、<em>非同期コンテキスト</em> になります。
唯一の例外は <code>query</code> 関数で、そのボディ内は非同期コンテキストとは見なされません。</p>
</div>
<div class="paragraph">
<p>Motokoでは、shared 関数を呼び出すと、その関数が非同期コンテキストで呼び出されない限りエラーになります。また、Actor クラスのコンストラクタから shared 関数を呼び出してもエラーになります。</p>
</div>
<div class="paragraph">
<p><code>await</code> 構文は非同期コンテキストでのみ使用できます。</p>
</div>
<div class="paragraph">
<p><code>async</code> 構文は非同期コンテキストでのみ使用できます。</p>
</div>
<div class="paragraph">
<p>非同期コンテキストでは、エラーを <code>throw</code> または <code>try/catch</code> することしかできません。
これは、構造化されたエラー処理がメッセージングエラーに対してのみサポートされており、メッセージングそのものと同様、非同期コンテキストに限定されているためです。</p>
</div>
<div class="paragraph">
<p>これらのルールは、ローカル関数は一般的に shared 関数を直接呼び出したり、future を <code>await</code> することができないことを意味します。この制限は時に厄介なものです。将来的には型システムを拡張することで、より寛容にしたいと考えています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="actor_classes"><a class="anchor" href="#actor_classes"></a>Actor クラスによる Actor の一般化</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Actor <em>クラス</em> は、単一の Actor 宣言を、同じインターフェイスを満たす Actor 群の宣言に一般化します。
Actor クラスは、Actor のインターフェイスを指定する型と、引数が与えられるたびにその型の新たな Actor を構築する関数を宣言します。
Actor クラスは、Actor を製造するファクトリーの役割を果たします。
Canister の設置は Internet Computer では非同期なので、コンストラクタ関数も非同期であり、Actor を future で返します。</p>
</div>
<div class="paragraph">
<p>例えば、コンストラクタのパラメータとして、<code>Nat</code> 型の変数 <code>init</code> を導入することで、上で与えられた <code>Counter</code> を以下の <code>Counter(init)</code> に一般化することができます。</p>
</div>
<div id="Counters" class="listingblock">
<div class="title">Counters.mo</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">actor class Counter(init : Nat) {
  var count = init;

  public func inc() : async () { count += 1 };

  public func read() : async Nat { count };

  public func bump() : async Nat {
    count += 1;
    count;
  };
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>このクラスが <code>Counters.mo</code> というファイルに格納されている場合には、ファイルをモジュールとしてインポートし、それを使って初期値の異なる複数のアクターを作ることができます。</p>
</div>
<div class="listingblock include_Counters">
<div class="content">
<pre class="highlightjs highlight"><code class="language-motoko hljs" data-lang="motoko">import Counters "Counters";

let C1 = await Counters.Counter(1);
let C2 = await Counters.Counter(2);
(await C1.read(), await C2.read())</code></pre>
</div>
</div>
<div class="paragraph">
<p>上の最後の2行は、Actor クラスを2回 <em>インスタンス化</em> しています。
最初の呼び出しでは初期値 <code>1</code> を使用し、2回目の呼び出しでは初期値 <code>2</code> を使用します。
Actor クラスのインスタンス化は非同期的なので、<code>Counter(init)</code> の各呼び出しは future を返し、結果として得られる Actor の値を <code>await</code> することができます。
<code>C1</code> と <code>C2</code> はどちらも同じ <code>Counters.Counter</code> 型であり、互換性を持って使用することができます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
現在のところ、Motoko コンパイラは、単一の Actor または Actor クラスで構成されていないプログラムをコンパイルするとエラーになります。
しかし、コンパイルされたプログラムは、インポートされた Actor クラスを参照することができます。
詳しくは <a href="modules-and-imports.html#importing_actor_classes">Actor クラスのインポート</a> と <a href="actor-classes.html#actor_classes">Actor クラス</a> を参照してください。
</td>
</tr>
</table>
</div>
</div>
</div>
</article>
<aside class="toc sidebar">
  
  <div class="toc-menu"></div>
</aside></div>
</main></div>
<footer class="footer">
  <div class="footer-container">
    <a href="http://www.dfinity.org"><img class="footer-logo" src="../../_/img/logo.svg"></a>
    <nav class="footer-nav">
      <div class="col1">
        <h5 class="footer-header">Developers</h5>
        <a class="footer-link" href="http://www.dfinity.org/faq">
          FAQ
        </a>
        <a class="footer-link" href="#">
          Developers
        </a>
        <a class="footer-link" href="http://www.dfinity.org/data-centers">
          Data Centers
        </a>
      </div>

      <div class="col2">
        <h5 class="footer-header">Team</h5>
        <a class="footer-link" href="http://www.dfinity.org/foundation">
          Foundation
        </a>
        <a class="footer-link" href="http://www.dfinity.org/foundation#events">
          Events
        </a>
        <a class="footer-link" href="http://www.dfinity.org/careers">
          Careers
        </a>
      </div>


      <div class="col3">
        <h5 class="footer-header">Media</h5>
        <a class="footer-link" href="http://www.dfinity.org/media">
          Featured Videos
        </a>
        <a class="footer-link" href="http://www.dfinity.org/media#featured-stories">
          Featured Stories
        </a>
        <a class="footer-link" href="http://www.dfinity.org/newsletter">
          Newsletter
        </a>
      </div>

      <div class="social-icons">

        <a class="social-icon-link" target="blank" href="https://github.com/dfinity">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M12 0C5.3625 0 0 5.3625 0 12C0 17.2875 3.45 21.7875 8.2125 23.4C8.8125 23.5125 9.0375 23.1375 9.0375 22.8375C9.0375 22.5375 9.0375 21.7875 9.0375 20.8125C5.7 21.525 4.9875 19.2 4.9875 19.2C4.425 17.8125 3.6375 17.4375 3.6375 17.4375C2.55 16.6875 3.7125 16.725 3.7125 16.725C4.9125 16.8 5.55 17.9625 5.55 17.9625C6.6375 19.8 8.3625 19.275 9.0375 18.975C9.15 18.1875 9.45 17.6625 9.7875 17.3625C7.125 17.0625 4.3125 16.0125 4.3125 11.4375C4.3125 10.125 4.7625 9.075 5.55 8.2125C5.4375 7.9125 5.025 6.675 5.6625 5.025C5.6625 5.025 6.675 4.6875 8.9625 6.2625C9.9375 6 10.95 5.85 11.9625 5.85C12.975 5.85 14.025 6 14.9625 6.2625C17.25 4.725 18.2625 5.025 18.2625 5.025C18.9 6.675 18.4875 7.9125 18.375 8.2125C19.1625 9.0375 19.6125 10.125 19.6125 11.4375C19.6125 16.05 16.8 17.0625 14.1375 17.3625C14.55 17.7375 14.9625 18.45 14.9625 19.575C14.9625 21.1875 14.9625 22.4625 14.9625 22.875C14.9625 23.2125 15.1875 23.5875 15.7875 23.4375C20.55 21.7875 24 17.2875 24 12C24 5.3625 18.6375 0 12 0Z"
              fill="#333333" />
          </svg>

        </a>
        <a class="social-icon-link" target="blank" href="https://medium.com/dfinity-network-blog">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M22.3125 1H1.6875C1.50516 1 1.3303 1.07243 1.20136 1.20136C1.07243 1.3303 1 1.50516 1 1.6875L1 22.3125C1 22.4948 1.07243 22.6697 1.20136 22.7986C1.3303 22.9276 1.50516 23 1.6875 23H22.3125C22.4948 23 22.6697 22.9276 22.7986 22.7986C22.9276 22.6697 23 22.4948 23 22.3125V1.6875C23 1.50516 22.9276 1.3303 22.7986 1.20136C22.6697 1.07243 22.4948 1 22.3125 1V1ZM19.2768 6.21228L18.0971 7.34356C18.0471 7.38153 18.0085 7.43245 17.9854 7.4908C17.9623 7.54916 17.9557 7.61272 17.9661 7.67459V15.9875C17.9557 16.0494 17.9623 16.1129 17.9854 16.1713C18.0085 16.2296 18.0471 16.2806 18.0971 16.3185L19.2493 17.4498V17.698H13.4534V17.4498L14.6469 16.2903C14.7641 16.1731 14.7641 16.1388 14.7641 15.9593V9.24072L11.4455 17.6698H10.9987L7.13319 9.24072V14.8899C7.11729 15.0071 7.12828 15.1264 7.16533 15.2387C7.20237 15.351 7.2645 15.4535 7.347 15.5382L8.89937 17.4213V17.6695H4.49731V17.4213L6.04969 15.5382C6.13152 15.4534 6.19226 15.3505 6.22701 15.2379C6.26177 15.1253 6.26956 15.0061 6.24975 14.8899V8.35866C6.25855 8.26945 6.24627 8.17943 6.21391 8.09584C6.18155 8.01225 6.13001 7.93743 6.06344 7.87741L4.68362 6.21503V5.96684H8.96847L12.2805 13.2303L15.1924 5.96684H19.2768V6.21228Z"
              fill="#333333" />
          </svg>

        </a>
        <a class="social-icon-link" target="blank" href="https://twitter.com/dfinity">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M23 5.33654C22.175 5.67308 21.3156 5.94231 20.4219 6.04327C21.35 5.50481 22.0719 4.62981 22.4156 3.58654C21.5562 4.09135 20.5938 4.46154 19.5625 4.66346C18.7031 3.78846 17.5344 3.25 16.2281 3.25C13.7187 3.25 11.725 5.23558 11.725 7.65865C11.725 7.99519 11.7594 8.33173 11.8281 8.66827C8.08125 8.5 4.74688 6.71635 2.54688 4.05769C2.16875 4.69712 1.92813 5.47115 1.92813 6.27885C1.92813 7.82692 2.71875 9.17308 3.92188 9.94712C3.16562 9.91346 2.47812 9.71154 1.89375 9.40865C1.89375 9.44231 1.89375 9.44231 1.89375 9.47596C1.89375 11.6298 3.44063 13.4135 5.50313 13.8173C5.125 13.9183 4.7125 13.9856 4.3 13.9856C4.025 13.9856 3.71562 13.9519 3.44062 13.9183C4.025 15.6683 5.675 16.9471 7.66875 16.9808C6.12187 18.1587 4.1625 18.8654 2.06562 18.8654C1.6875 18.8654 1.34375 18.8317 1 18.7981C2.99375 20.0096 5.36563 20.75 7.90938 20.75C16.2281 20.75 20.7656 14.0192 20.7656 8.16346C20.7656 7.96154 20.7656 7.79327 20.7656 7.59135C21.625 6.98558 22.3813 6.21154 23 5.33654Z"
              fill="#333333" />
          </svg>

        </a>

        <a class="social-icon-link" target="blank" href="https://forum.dfinity.org/">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M12.0932 1C6.0727 1 1 5.83706 1 11.8085C1 12 1.00488 23 1.00488 23L12.0933 22.9901C18.1188 22.9901 23 17.9666 23 11.9951C23 6.02373 18.1188 1 12.0932 1ZM12 18.2857C11.0473 18.2857 10.1388 18.0745 9.32853 17.6916L5.34597 18.6786L6.47047 14.9956C5.98926 14.1067 5.71423 13.0853 5.71423 12C5.71423 8.52815 8.52811 5.71428 12 5.71428C15.4719 5.71428 18.2857 8.52815 18.2857 12C18.2857 15.472 15.4719 18.2857 12 18.2857Z"
              fill="#333333" />
          </svg>

        </a>

        <a class="social-icon-link" target="blank" href="https://www.linkedin.com/company/dfinity'">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M1 4.35878C1 3.01688 2.03589 2 3.61924 2C5.20139 2 6.17406 3.01448 6.20507 4.35519C6.20507 5.67205 5.20139 6.71456 3.58942 6.71456H3.55841C2.00666 6.71456 1 5.67562 1 4.35878ZM17.5581 8.28158C15.1017 8.28158 13.5625 9.61217 13.278 10.5449V8.41225H8.46122C8.52324 9.54475 8.46122 21.9995 8.46122 21.9995H13.278V14.647C13.278 14.5987 13.2778 14.5505 13.2775 14.5025C13.2756 14.1436 13.2736 13.7952 13.383 13.5365C13.714 12.7194 14.4255 11.8719 15.7046 11.8719C17.3775 11.8719 18.1378 13.128 18.1378 14.9685V21.9995H23V14.4448C23 10.236 20.6056 8.28158 17.5581 8.28158ZM1.55371 8.41275H5.84157V22H1.55371V8.41275Z"
              fill="#333333" />
          </svg>

        </a>

        <a class="social-icon-link" target="blank" href="https://youtube.com/dfinity">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M23.775 7.6375C23.775 7.6375 23.55 5.9875 22.8375 5.2375C21.9375 4.3 20.8875 4.2625 20.4375 4.225C17.025 4 12 4 12 4C12 4 6.975 4 3.6 4.225C3.1125 4.2625 2.1 4.3 1.2 5.2375C0.4875 5.95 0.2625 7.6375 0.2625 7.6375C0.2625 7.6375 0 9.5875 0 11.5375V13.375C0 15.325 0.225 17.275 0.225 17.275C0.225 17.275 0.45 18.925 1.1625 19.675C2.0625 20.6125 3.2625 20.6125 3.825 20.6875C5.7375 20.875 12 20.9125 12 20.9125C12 20.9125 17.025 20.9125 20.4 20.65C20.8875 20.6125 21.9 20.575 22.8 19.6375C23.5125 18.925 23.7375 17.2375 23.7375 17.2375C23.7375 17.2375 24 15.2875 24 13.3375V11.5C24 9.5875 23.775 7.6375 23.775 7.6375ZM9.525 15.55V8.8L16.0125 12.175L9.525 15.55Z"
              fill="#333333" />
          </svg>

        </a>

      </div>
    </nav>

    <div class="legal-container">
      <span class="legal" id="year">
        © 2020 DFINITY
      </span>
      <a class="legal footer-link" href="http://www.dfinity.org/terms-of-use">
        Terms of Use
      </a>
      <a class="legal footer-link" href="http://www.dfinity.org/cookie-policy">
        Cookie Policy
      </a>
      <a class="legal footer-link" href="http://www.dfinity.org/privacy-policy">
        Privacy Policy
      </a>
    </div>

  </div>
</footer>


<script>
  var today = new Date();
  var year = today.getFullYear();
  document.getElementById("year").innerHTML = `© ${year} DFINITY`;
</script><script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
    apiKey: 'b93d56cc4b00b0afbcdaacab04dcf25b',
    indexName: 'dfinity_sdk',
    inputSelector: '.search-input',
    debug: false // Set debug to true if you want to inspect the dropdown
  });
</script>

<!-- Start of dfinity Zendesk Widget script -->
<script id="ze-snippet" src="https://static.zdassets.com/ekr/snippet.js?key=53121947-c10a-484c-b99b-f89a9fb6f63e"> </script>
<!-- End of dfinity Zendesk Widget script -->

<script src="../../_/js/vendor/run_repl.js"></script>
<script type="module">
  import {CodeJar} from 'https://cdn.jsdelivr.net/npm/codejar@3.2.3/codejar.min.js';
  import {withLineNumbers} from 'https://cdn.jsdelivr.net/npm/codejar@3.2.3/linenumbers.js';
  window.CodeJar = CodeJar;
  window.withLineNumbers = withLineNumbers;
</script> 
<script type="text/javascript">
async function addPackage(name, repo, version, dir) {
  const meta_url = `../../_/js/vendor/${repo}/flat`;
  const base_url = `../../_/js/vendor/${repo}`;
  const response = await fetch(meta_url);
  const json = await response.json()
  const promises = [];
  const fetchedFiles = [];
  for (const f of json.files) {
    if (f.name.startsWith(`/${dir}/`) && /\.mo$/.test(f.name)) {
      const promise = (async () => {
        const content = await (await fetch(base_url + f.name)).text();
        const stripped = name + f.name.slice(dir.length + 1);
        fetchedFiles.push(stripped);
        Motoko.saveFile(stripped, content);
      })();
      promises.push(promise);
    }
  }
  Promise.all(promises).then(() => {
    Motoko.addPackage(name, name + '/');
    console.log("base library loaded");
    changeCodeBlock(); // from run_repl.js
  });
}
function loadBase() {
  addPackage('base', 'dfinity/motoko-base', 'moc-0.6.27', 'src');
}
</script>
<script async src="../../_/js/vendor/moc.js" onload="loadBase()">
</script>
  </body>
</html>
